# ───────────────────────────────────────────────────────────────────────────────
# Direct Connect Gateways & Associations (Core TGWs Only)
# ───────────────────────────────────────────────────────────────────────────────
# us-east-1
resource "aws_dx_gateway" "core_dxgw_us_east_1" {
  for_each = lookup(local.dx_envs_by_region, "us_east_1", {})
  provider = aws.us_east_1

  name            = "${each.key}-core-dxgw"
  amazon_side_asn = 64512 + index(local.sorted_region_setups, each.key)
}

resource "aws_dx_gateway_association" "core_dx_to_tgw_us_east_1" {
  for_each = lookup(local.dx_envs_by_region, "us_east_1", {})
  provider = aws.us_east_1

  dx_gateway_id         = aws_dx_gateway.core_dxgw_us_east_1[each.key].id
  associated_gateway_id = aws_ec2_transit_gateway.core_tgw_us_east_1[each.key].id

  allowed_prefixes = [
    var.region_setups[each.key].primary_cidrs.core,
    var.region_setups[each.key].secondary_cidrs.core,
  ]
}

# eu-west-1
resource "aws_dx_gateway" "core_dxgw_eu_west_1" {
  for_each = lookup(local.dx_envs_by_region, "eu_west_1", {})
  provider = aws.eu_west_1

  name            = "${each.key}-core-dxgw"
  amazon_side_asn = 64513 + index(local.sorted_region_setups, each.key)
}

resource "aws_dx_gateway_association" "core_dx_to_tgw_eu_west_1" {
  for_each = lookup(local.dx_envs_by_region, "eu_west_1", {})
  provider = aws.eu_west_1

  dx_gateway_id         = aws_dx_gateway.core_dxgw_eu_west_1[each.key].id
  associated_gateway_id = aws_ec2_transit_gateway.core_tgw_eu_west_1[each.key].id

  allowed_prefixes = [
    var.region_setups[each.key].primary_cidrs.core,
    var.region_setups[each.key].secondary_cidrs.core,
  ]
}

# ap-east-1
resource "aws_dx_gateway" "core_dxgw_ap_east_1" {
  for_each = lookup(local.dx_envs_by_region, "ap_east_1", {})
  provider = aws.ap_east_1

  name            = "${each.key}-core-dxgw"
  amazon_side_asn = 64514 + index(local.sorted_region_setups, each.key)
}

resource "aws_dx_gateway_association" "core_dx_to_tgw_ap_east_1" {
  for_each = lookup(local.dx_envs_by_region, "ap_east_1", {})
  provider = aws.ap_east_1

  dx_gateway_id         = aws_dx_gateway.core_dxgw_ap_east_1[each.key].id
  associated_gateway_id = aws_ec2_transit_gateway.core_tgw_ap_east_1[each.key].id

  allowed_prefixes = [
    var.region_setups[each.key].primary_cidrs.core,
    var.region_setups[each.key].secondary_cidrs.core,
  ]
}

# ap-northeast-1
resource "aws_dx_gateway" "core_dxgw_ap_northeast_1" {
  for_each = lookup(local.dx_envs_by_region, "ap_northeast_1", {})
  provider = aws.ap_northeast_1

  name            = "${each.key}-core-dxgw"
  amazon_side_asn = 64515 + index(local.sorted_region_setups, each.key)
}

resource "aws_dx_gateway_association" "core_dx_to_tgw_ap_northeast_1" {
  for_each = lookup(local.dx_envs_by_region, "ap_northeast_1", {})
  provider = aws.ap_northeast_1

  dx_gateway_id         = aws_dx_gateway.core_dxgw_ap_northeast_1[each.key].id
  associated_gateway_id = aws_ec2_transit_gateway.core_tgw_ap_northeast_1[each.key].id

  allowed_prefixes = [
    var.region_setups[each.key].primary_cidrs.core,
    var.region_setups[each.key].secondary_cidrs.core,
  ]
}

# ap-southeast-1
resource "aws_dx_gateway" "core_dxgw_ap_southeast_1" {
  for_each = lookup(local.dx_envs_by_region, "ap_southeast_1", {})
  provider = aws.ap_southeast_1

  name            = "${each.key}-core-dxgw"
  amazon_side_asn = 64516 + index(local.sorted_region_setups, each.key)
}

resource "aws_dx_gateway_association" "core_dx_to_tgw_ap_southeast_1" {
  for_each = lookup(local.dx_envs_by_region, "ap_southeast_1", {})
  provider = aws.ap_southeast_1

  dx_gateway_id         = aws_dx_gateway.core_dxgw_ap_southeast_1[each.key].id
  associated_gateway_id = aws_ec2_transit_gateway.core_tgw_ap_southeast_1[each.key].id

  allowed_prefixes = [
    var.region_setups[each.key].primary_cidrs.core,
    var.region_setups[each.key].secondary_cidrs.core,
  ]
}

# eu-central-1
resource "aws_dx_gateway" "core_dxgw_eu_central_1" {
  for_each = lookup(local.dx_envs_by_region, "eu_central_1", {})
  provider = aws.eu_central_1

  name            = "${each.key}-core-dxgw"
  amazon_side_asn = 64517 + index(local.sorted_region_setups, each.key)
}

resource "aws_dx_gateway_association" "core_dx_to_tgw_eu_central_1" {
  for_each = lookup(local.dx_envs_by_region, "eu_central_1", {})
  provider = aws.eu_central_1

  dx_gateway_id         = aws_dx_gateway.core_dxgw_eu_central_1[each.key].id
  associated_gateway_id = aws_ec2_transit_gateway.core_tgw_eu_central_1[each.key].id

  allowed_prefixes = [
    var.region_setups[each.key].primary_cidrs.core,
    var.region_setups[each.key].secondary_cidrs.core,
  ]
}

# eu-west-2
resource "aws_dx_gateway" "core_dxgw_eu_west_2" {
  for_each = lookup(local.dx_envs_by_region, "eu_west_2", {})
  provider = aws.eu_west_2

  name            = "${each.key}-core-dxgw"
  amazon_side_asn = 64518 + index(local.sorted_region_setups, each.key)
}

resource "aws_dx_gateway_association" "core_dx_to_tgw_eu_west_2" {
  for_each = lookup(local.dx_envs_by_region, "eu_west_2", {})
  provider = aws.eu_west_2

  dx_gateway_id         = aws_dx_gateway.core_dxgw_eu_west_2[each.key].id
  associated_gateway_id = aws_ec2_transit_gateway.core_tgw_eu_west_2[each.key].id


  allowed_prefixes = [
    var.region_setups[each.key].primary_cidrs.core,
    var.region_setups[each.key].secondary_cidrs.core,
  ]
}